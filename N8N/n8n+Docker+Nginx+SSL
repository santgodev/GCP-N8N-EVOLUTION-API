# Step 1: Actualizar paquetes
sudo apt update && sudo apt upgrade -y

# Step 2: Instalar Docker
sudo apt install -y docker.io

# Step 3: Habilitar Docker al inicio
sudo systemctl enable --now docker

# Step 4: Ejecutar contenedor n8n con tu dominio
sudo docker run -d --restart unless-stopped -it \
--name n8n \
-p 5678:5678 \
-e N8N_HOST="www.sanuva.online" \
-e WEBHOOK_TUNNEL_URL="https://www.sanuva.online/" \
-e WEBHOOK_URL="https://www.sanuva.online/" \
-v ~/.n8n:/root/.n8n \
n8nio/n8n

# Step 5: Instalar Nginx
sudo apt install -y nginx

# Step 6: Crear configuración Nginx para n8n
sudo bash -c 'cat > /etc/nginx/sites-available/n8n <<EOF
server {
    listen 80;
    server_name www.sanuva.online;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    server_name www.sanuva.online;

    ssl_certificate /etc/letsencrypt/live/www.sanuva.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/www.sanuva.online/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://localhost:5678;
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;

        # Headers for WebSocket support
        proxy_set_header Connection "Upgrade";
        proxy_set_header Upgrade \$http_upgrade;

        # Additional headers for forwarding client info
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF'

# Step 7: Activar la configuración de Nginx
sudo ln -s /etc/nginx/sites-available/n8n /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# Step 8: Instalar Certbot
sudo apt install -y certbot python3-certbot-nginx

# Step 9: Obtener certificado SSL para tu dominio
sudo certbot --nginx -d www.sanuva.online

# Step 10: Reiniciar Nginx
sudo systemctl restart nginx
